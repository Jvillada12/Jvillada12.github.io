<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Encuestas - YaYa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ESTILOS ORIGINALES DEL PANEL YAYA */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --yaya-green: #2AA048;
            --yaya-dark: #228C3A;
            --yaya-light: #E8F5E9;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--yaya-green) 0%, var(--yaya-dark) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* LOGIN */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 400px; width: 100%; }
        .login-title { text-align: center; color: var(--yaya-green); font-size: 32px; margin-bottom: 10px; }
        .login-subtitle { text-align: center; color: #6b7280; font-size: 14px; margin-bottom: 30px; }
        .login-form .form-group { margin-bottom: 20px; }
        .login-form label { display: block; color: #374151; font-weight: 500; margin-bottom: 8px; }
        .login-form input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .login-btn { width: 100%; padding: 14px; background: var(--yaya-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .login-error { color: #ef4444; font-size: 14px; margin-top: 10px; display: none; }
        .login-error.visible { display: block; }
        
        /* APP CONTAINER */
        .app-container { display: none; }
        .app-container.active { display: block; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { background: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: var(--yaya-green); font-size: 28px; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 10px; padding: 8px 15px; background: #f9fafb; border-radius: 8px; }
        .user-info i { color: var(--yaya-green); }
        
        /* SECCIONES */
        .section { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 22px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .section-title.nuevos { color: var(--yaya-green); }
        .section-title.historico { color: #374151; }
        
        .section-controls { display: flex; gap: 10px; }
        .collapse-btn { padding: 8px 16px; border: 1px solid #d1d5db; background: white; cursor: pointer; border-radius: 6px; }
        .section-content { max-height: 2000px; overflow: hidden; transition: max-height 0.3s; }
        .section-content.collapsed { max-height: 0; }
        
        /* FILTROS */
        .filtros-container { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .filtro-busqueda { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .filtro-busqueda input { flex: 1; padding: 12px 15px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .filtro-fecha { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .date-input { padding: 10px 15px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .filtro-limpiar-btn { padding: 8px 15px; border: 1px solid #ef4444; background: white; color: #ef4444; border-radius: 6px; cursor: pointer; margin-left: auto; }
        .filtro-limpiar-btn:hover { background: #ef4444; color: white; }

        /* CARDS */
        .usuario-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: all 0.3s; }
        .usuario-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .usuario-card h3 { color: #1f2937; font-size: 18px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .usuario-info { color: #6b7280; font-size: 14px; margin-bottom: 5px; }
        
        .cards-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .btn { background: var(--yaya-green); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: #4b5563; } 
        .btn-logout { background: #ef4444; }
        
        /* PAGINACIÓN */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0; }
        .pagination button { padding: 8px 16px; border: 1px solid #d1d5db; background: white; cursor: pointer; border-radius: 6px; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 10px; padding: 30px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        
        .loading, .empty { text-align: center; padding: 40px; color: #6b7280; }
        
        /* SEMÁFORO Y ESTADOS */
        .score-badge { display: inline-flex; align-items: center; gap: 8px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .score-badge.zona-gris { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; }
        .score-badge.aprobado { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-aprobar { background: #10b981; }
        .btn-rechazar { background: #ef4444; }
    </style>
</head>
<body>
    <div class="login-container" id="login-screen">
        <div class="login-box">
            <h1 class="login-title">YaYa</h1>
            <p class="login-subtitle">Panel de Encuestas Crediticias</p>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="login-btn">Iniciar Sesión</button>
                <div class="login-error" id="login-error">Credenciales incorrectas</div>
            </form>
        </div>
    </div>

    <div class="app-container" id="app-container">
        <div class="container">
            <div class="header">
                <h1>Panel de Encuestas YaYa</h1>
                <div class="header-right">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="user-name">Operador</span>
                    </div>
                    <button class="btn btn-logout" onclick="handleLogout()">Salir</button>
                    <button class="btn" id="btn-refresh" onclick="refrescarDatos()">
                        <i class="fas fa-sync-alt"></i> Refrescar
                    </button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-title nuevos">
                        <i class="fas fa-user-plus"></i>
                        <span>USUARIOS NUEVOS (Sin encuesta)</span>
                        <span class="badge" style="background:#E8F5E9; color:#228C3A; padding:4px 10px; border-radius:10px; font-size:12px; margin-left:10px;" id="count-nuevos">0</span>
                    </div>
                    <div class="section-controls">
                        <button class="collapse-btn" onclick="toggleSection('nuevos')">Colapsar</button>
                    </div>
                </div>
                
                <div class="filtros-container">
                    <div class="filtro-busqueda">
                        <i class="fas fa-search"></i>
                        <input type="text" id="filtro-busqueda" placeholder="Buscar por nombre, cédula, teléfono o email..." onkeyup="actualizarFiltroTexto()">
                    </div>
                    <div class="filtro-fecha">
                        <span><i class="fas fa-calendar-alt"></i> Filtrar por fecha de registro:</span>
                        <label>Desde:</label> <input type="date" id="fecha-inicio" onchange="actualizarFiltroFecha()" class="date-input">
                        <label>Hasta:</label> <input type="date" id="fecha-fin" onchange="actualizarFiltroFecha()" class="date-input">
                        <button class="filtro-limpiar-btn" onclick="limpiarFiltros()">Limpiar Filtros</button>
                    </div>
                </div>
                
                <div class="section-content" id="content-nuevos">
                    <div id="usuarios-nuevos" class="cards-view">
                        <div class="loading">Cargando usuarios nuevos...</div>
                    </div>
                    <div class="pagination" id="pagination-nuevos"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-title" style="color: #f59e0b;">
                        <i class="fas fa-hourglass-half"></i>
                        <span>USUARIOS POR APROBAR (Pendientes de Decisión)</span>
                        <span id="count-aprobar" style="background:#fef3c7; padding:4px 10px; border-radius:10px; font-size:12px; margin-left:10px;">0</span>
                    </div>
                    <div class="section-controls">
                        <button class="collapse-btn" onclick="toggleSection('aprobar')">Colapsar</button>
                    </div>
                </div>
                <div class="section-content" id="content-aprobar">
                    <div id="usuarios-aprobar" class="cards-view">
                        <div class="loading">Cargando pendientes...</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <div class="section-title historico">
                        <i class="fas fa-table"></i>
                        <span>HISTÓRICO - Todos los Procesados</span>
                        <span id="count-historico" style="background:#f3f4f6; padding:4px 10px; border-radius:10px; font-size:12px; margin-left:10px;">0</span>
                    </div>
                    <button class="collapse-btn" onclick="toggleSection('historico')">Colapsar</button>
                </div>
                <div class="section-content" id="content-historico">
                    <div id="usuarios-historico">
                        <div class="loading">Cargando histórico...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-encuesta">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h2>Encuesta Telefónica</h2>
                <button onclick="cerrarModal()" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">X</button>
            </div>
            <div id="usuario-seleccionado" style="background:#f0fdf4; padding:15px; margin-bottom:20px; border-radius:8px;"></div>
            
            <form id="form-encuesta" onsubmit="guardarEncuesta(event)">
                <div class="form-grid">
                    <div class="form-group"><label>Estado Civil</label><select id="estadoCivil" required><option value="">Selec...</option><option value="Soltero">Soltero</option><option value="Casado">Casado</option><option value="Union Libre">Unión Libre</option></select></div>
                    <div class="form-group"><label>Nº Hijos</label><input type="number" id="numeroHijos" required></div>
                    <div class="form-group"><label>Nivel Educación</label><select id="nivelEducacion" required><option value="Bachillerato">Bachillerato</option><option value="Universitario">Universitario</option><option value="Tecnico">Técnico</option></select></div>
                    <div class="form-group"><label>Ocupación</label><select id="ocupacionLaboral" required><option value="Empleado">Empleado</option><option value="Independiente">Independiente</option></select></div>
                    <div class="form-group"><label>Ingreso Mensual</label><input type="text" id="ingresoMensualPromedio" required></div>
                    <div class="form-group"><label>Gastos Mensuales</label><input type="text" id="gastosMenuales" required></div>
                    <div class="form-group"><label>Ahorro Mensual</label><input type="text" id="ahorroMensual" required></div>
                    <div class="form-group"><label>Reportado en Centrales</label><select id="reportadoCentrales" required><option value="No">No</option><option value="Si">Si</option></select></div>
                </div>
                
                <input type="hidden" id="cuentaBancariaActiva" value="Si">
                <input type="hidden" id="frecuenciaIngreso" value="Mensual">
                <input type="hidden" id="prestamosAnteriores" value="No">
                <input type="hidden" id="incumplimientoPrestamo" value="No">
                <input type="hidden" id="retrasoServiciosPublicos" value="No">
                <input type="hidden" id="operadorCelular" value="Claro">
                <input type="hidden" id="tipoPlan" value="Prepago">
                <input type="hidden" id="tiempoUso" value="12 meses">

                <div class="form-group"><label>Observaciones</label><textarea id="observaciones" style="width:100%; height:80px;"></textarea></div>
                <button type="submit" class="btn" style="width:100%; justify-content:center; padding:15px; font-size:16px;">Enviar a Underwriting</button>
            </form>
        </div>
    </div>

    <script>
        // === CONFIGURACIÓN ===
        const AWS_CONFIG = {
            endpoint: 'https://3suq2zi6dvdbbfiaqt4o566zjq.appsync-api.us-east-1.amazonaws.com/graphql',
            apiKey: 'da2-yon3f4lcrvfszcnh7pnt7imjpu',
            region: 'us-east-1'
        };

        const COGNITO_CONFIG = {
            userPoolId: 'us-east-1_rA1qYSot0',
            clientId: '7itqatg8o82n8sbcdgembbi9fi',
            region: 'us-east-1'
        };

        let datosUsuarios = { nuevos: [], historico: [], aprobar: [] };
        let paginaActual = { nuevos: 1, historico: 1, aprobar: 1 };
        const ITEMS_POR_PAGINA = 20; // Paginación arreglada a 20
        let usuarioActual = null;
        let currentUser = null;
        let usuariosNoContestaron = new Set();

        // Filtros Globales
        let filtroTexto = '';
        let filtroFechaInicio = null;
        let filtroFechaFin = null;

        // === UTILIDADES ===
        function parsearFecha(input) {
            if (!input) return null;
            // Corrección de Timestamp: Si es pequeño (segundos), convertir a milisegundos
            if (!isNaN(input)) {
                let timestamp = parseInt(input);
                if (timestamp < 10000000000) timestamp *= 1000;
                return new Date(timestamp);
            }
            return new Date(input);
        }

        async function graphqlRequest(query, variables = {}) {
            const response = await fetch(AWS_CONFIG.endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': AWS_CONFIG.apiKey },
                body: JSON.stringify({ query, variables })
            });
            const result = await response.json();
            if (result.errors) throw new Error(result.errors[0].message);
            return result.data;
        }

        // === AUTH ===
        window.onload = function() {
            if(sessionStorage.getItem('userToken')) {
                currentUser = sessionStorage.getItem('username');
                document.getElementById('user-name').textContent = currentUser;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').classList.add('active');
                cargarDatos();
            }
        };

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            // Login con Cognito Real (como en original)
            try {
                const res = await fetch(`https://cognito-idp.${COGNITO_CONFIG.region}.amazonaws.com/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-amz-json-1.1', 'X-Amz-Target': 'AWSCognitoIdentityProviderService.InitiateAuth' },
                    body: JSON.stringify({
                        AuthFlow: 'USER_PASSWORD_AUTH',
                        ClientId: COGNITO_CONFIG.clientId,
                        AuthParameters: { USERNAME: u, PASSWORD: p }
                    })
                });
                const data = await res.json();
                if(data.AuthenticationResult) {
                    sessionStorage.setItem('userToken', data.AuthenticationResult.IdToken);
                    sessionStorage.setItem('username', u);
                    location.reload();
                } else {
                    alert("Credenciales incorrectas");
                }
            } catch(err) { alert("Error de conexión: " + err.message); }
        }

        function handleLogout() { sessionStorage.clear(); location.reload(); }

        // === CARGA DE DATOS ===
        async function refrescarDatos() {
            const btn = document.getElementById('btn-refresh');
            const txt = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
            btn.disabled = true;
            
            // Limpiar datos
            datosUsuarios = { nuevos: [], historico: [], aprobar: [] };
            
            try {
                await cargarDatos();
            } catch(e) { console.error(e); }
            
            btn.innerHTML = txt;
            btn.disabled = false;
        }

        async function cargarDatos() {
            await Promise.all([cargarUsuariosNuevos(), cargarUsuariosPorAprobar(), cargarHistorico()]);
        }

        async function cargarUsuariosNuevos() {
            try {
                // 1. Obtener encuestados para no repetir
                let encuestados = new Set();
                try {
                    const qEnc = `query E { listScoringUnderwritings(limit:3000) { items { numeroCedula } } }`;
                    const dEnc = await graphqlRequest(qEnc);
                    dEnc.listScoringUnderwritings.items.forEach(i => encuestados.add(i.numeroCedula));
                } catch(e) {}

                // 2. Obtener usuarios
                let usuarios = [];
                let nextToken = null;
                let loops = 0;
                
                do {
                    const q = `query U($tk: String) { listUsuarios(limit:1000, nextToken:$tk) { items { id nombres apellidos idGobierno celConfirm email tiempoRegistro dirCasa } nextToken } }`;
                    const d = await graphqlRequest(q, { tk: nextToken });
                    const items = d.listUsuarios.items || [];
                    
                    for(let u of items) {
                        if(encuestados.has(u.idGobierno)) continue;
                        usuarios.push(u);
                    }
                    nextToken = d.listUsuarios.nextToken;
                    loops++;
                } while(nextToken && loops < 5); // Limite seguridad

                // Ordenar por fecha reciente
                usuarios.sort((a,b) => parsearFecha(b.tiempoRegistro) - parsearFecha(a.tiempoRegistro));
                datosUsuarios.nuevos = usuarios;
                renderSeccion('nuevos');
                document.getElementById('count-nuevos').textContent = usuarios.length;

            } catch(e) { console.error(e); }
        }

        async function cargarUsuariosPorAprobar() {
            try {
                // FIX: Usamos campos seguros para evitar Validation Error
                const q = `query P { listUsuariosPendientesAprobacions(limit:1000) { items { id nombres apellidos celular score categoria scoringUnderwritingId } } }`;
                const d = await graphqlRequest(q);
                let items = d.listUsuariosPendientesAprobacions.items || [];
                
                // Enriquecer cédula desde ID si es necesario (Fix FieldUndefined)
                items = items.map(i => {
                    let cedula = i.numeroCedula;
                    if(!cedula && i.id && i.id.includes('-')) cedula = i.id.split('-')[0];
                    return { ...i, numeroCedula: cedula || 'Desconocida' };
                });

                datosUsuarios.aprobar = items;
                renderSeccion('aprobar');
                document.getElementById('count-aprobar').textContent = items.length;
            } catch(e) { console.error("Error aprobar", e); }
        }

        async function cargarHistorico() {
            try {
                const q = `query H { listHistoricoAprobadosRechazados(limit:100) { items { id nombreCompleto numeroCedula score decision montoAprobado fechaProceso operadorDecision } } }`;
                const d = await graphqlRequest(q);
                datosUsuarios.historico = d.listHistoricoAprobadosRechazados.items || [];
                renderSeccion('historico');
                document.getElementById('count-historico').textContent = datosUsuarios.historico.length;
            } catch(e) {}
        }

        // === RENDER Y FILTROS ===
        function aplicarFiltros(lista) {
            const texto = filtroTexto.toLowerCase();
            const ini = filtroFechaInicio ? new Date(filtroFechaInicio) : null;
            const fin = filtroFechaFin ? new Date(filtroFechaFin) : null;
            if(fin) fin.setHours(23,59,59);

            return lista.filter(u => {
                // Filtro Texto
                const matchTexto = (u.nombres+' '+u.apellidos+' '+u.idGobierno+' '+u.celConfirm).toLowerCase().includes(texto);
                
                // Filtro Fecha
                let matchFecha = true;
                const fecha = parsearFecha(u.tiempoRegistro);
                if(fecha) {
                    if(ini && fecha < ini) matchFecha = false;
                    if(fin && fecha > fin) matchFecha = false;
                }
                
                return matchTexto && matchFecha;
            });
        }

        function renderSeccion(tipo) {
            let lista = datosUsuarios[tipo];
            const container = document.getElementById(`usuarios-${tipo}`);
            
            // Aplicar filtros solo a nuevos
            if(tipo === 'nuevos') lista = aplicarFiltros(lista);

            // PAGINACIÓN (20 items)
            const pag = paginaActual[tipo];
            const totalPaginas = Math.ceil(lista.length / ITEMS_POR_PAGINA);
            const inicio = (pag - 1) * ITEMS_POR_PAGINA;
            const items = lista.slice(inicio, inicio + ITEMS_POR_PAGINA);

            if(lista.length === 0) {
                container.innerHTML = '<div class="loading">No hay datos para mostrar.</div>';
                document.getElementById(`pagination-${tipo}`).innerHTML = '';
                return;
            }

            if(tipo === 'nuevos') {
                container.innerHTML = items.map(u => {
                    const noC = usuariosNoContestaron.has(u.idGobierno);
                    return `
                    <div class="usuario-card" style="${noC ? 'border-left:4px solid #f59e0b; opacity:0.8' : ''}">
                        <h3><i class="fas fa-user"></i> ${u.nombres} ${u.apellidos} ${noC ? '<span style="font-size:12px; background:#fef3c7; padding:2px 5px; border-radius:4px">No Contestó</span>' : ''}</h3>
                        <p><strong>CC:</strong> ${u.idGobierno}</p>
                        <p><strong>Tel:</strong> ${u.celConfirm}</p>
                        <p style="color:#666; font-size:0.9em">Reg: ${parsearFecha(u.tiempoRegistro).toLocaleString()}</p>
                        <div class="action-buttons">
                            <button class="btn" style="width:48%" onclick='abrirEncuesta(${JSON.stringify(u)})'><i class="fas fa-edit"></i> Realizar Encuesta</button>
                            <button class="btn btn-secondary" style="width:48%" onclick='marcarNoContesto("${u.idGobierno}")'><i class="fas fa-phone-slash"></i> No Contestó</button>
                        </div>
                    </div>`;
                }).join('');
            } else if(tipo === 'aprobar') {
                container.innerHTML = items.map(u => `
                    <div class="usuario-card" style="border-left:4px solid ${u.score>=70?'#10b981':'#f59e0b'}">
                        <h3>${u.nombres} ${u.apellidos} <span class="score-badge ${u.score>=70?'aprobado':'zona-gris'}">Score: ${u.score.toFixed(1)}</span></h3>
                        <p><strong>CC:</strong> ${u.numeroCedula}</p>
                        <p><strong>Tel:</strong> ${u.celular}</p>
                        <div class="action-buttons">
                            <button class="btn btn-aprobar" style="width:48%" onclick='aprobar("${u.numeroCedula}")'>Aprobar</button>
                            <button class="btn btn-rechazar" style="width:48%" onclick='rechazar("${u.numeroCedula}")'>Rechazar</button>
                        </div>
                    </div>`).join('');
            } else {
                // Histórico tabla
                container.innerHTML = `<table style="width:100%">
                    <thead><tr style="background:#2AA048; color:white; text-align:left"><th>Nombre</th><th>CC</th><th>Score</th><th>Decisión</th><th>Monto</th></tr></thead>
                    <tbody>${items.map(u => `<tr>
                        <td style="padding:10px; border-bottom:1px solid #eee">${u.nombreCompleto}</td>
                        <td style="padding:10px; border-bottom:1px solid #eee">${u.numeroCedula}</td>
                        <td style="padding:10px; border-bottom:1px solid #eee">${u.score?u.score.toFixed(0):'-'}</td>
                        <td style="padding:10px; border-bottom:1px solid #eee; font-weight:bold; color:${u.decision==='APROBADO'?'#10b981':'#ef4444'}">${u.decision}</td>
                        <td style="padding:10px; border-bottom:1px solid #eee">${u.montoAprobado ? '$'+u.montoAprobado.toLocaleString() : '-'}</td>
                    </tr>`).join('')}</tbody>
                </table>`;
            }

            // Render Paginador
            const divPag = document.getElementById(`pagination-${tipo}`);
            if(totalPaginas > 1) {
                divPag.innerHTML = `
                    <button onclick="cambiarPagina('${tipo}', ${pag-1})" ${pag===1?'disabled':''}>Anterior</button>
                    <span>Pág ${pag} de ${totalPaginas}</span>
                    <button onclick="cambiarPagina('${tipo}', ${pag+1})" ${pag===totalPaginas?'disabled':''}>Siguiente</button>
                `;
            } else { divPag.innerHTML = ''; }
        }

        function cambiarPagina(tipo, p) {
            paginaActual[tipo] = p;
            renderSeccion(tipo);
        }

        // FUNCIONES UI
        function toggleSection(id) {
            const el = document.getElementById(`content-${id}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
        function marcarNoContesto(cc) {
            if(confirm("¿Marcar usuario como No Contestó?")) {
                usuariosNoContestaron.add(cc);
                renderSeccion('nuevos');
            }
        }
        function abrirEncuesta(u) {
            usuarioActual = u;
            document.getElementById('usuario-seleccionado').innerHTML = `<strong>${u.nombres} ${u.apellidos}</strong><br>CC: ${u.idGobierno}`;
            document.getElementById('modal-encuesta').classList.add('active');
        }
        function cerrarModal() { document.getElementById('modal-encuesta').classList.remove('active'); }
        
        async function guardarEncuesta(e) {
            e.preventDefault();
            // Lógica simplificada para mantener funcionamiento básico visual
            // Conecta aquí tu mutation createScoringUnderwriting exacta
            alert("Encuesta enviada a Underwriting (Simulación).");
            cerrarModal();
        }
        function aprobar(cc) { alert("Aprobar " + cc); }
        function rechazar(cc) { alert("Rechazar " + cc); }

        // Filtros Eventos
        function actualizarFiltroTexto() {
            filtroTexto = document.getElementById('filtro-busqueda').value;
            paginaActual.nuevos = 1;
            renderSeccion('nuevos');
        }
        function actualizarFiltroFecha() {
            filtroFechaInicio = document.getElementById('fecha-inicio').value;
            filtroFechaFin = document.getElementById('fecha-fin').value;
            paginaActual.nuevos = 1;
            renderSeccion('nuevos');
        }
        function limpiarFiltros() {
            document.getElementById('filtro-busqueda').value = '';
            document.getElementById('fecha-inicio').value = '';
            document.getElementById('fecha-fin').value = '';
            filtroTexto = ''; filtroFechaInicio = null; filtroFechaFin = null;
            renderSeccion('nuevos');
        }
    </script>
</body>
</html>
